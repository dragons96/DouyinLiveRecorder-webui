# 工作节点平台容量功能说明

## 功能概述

本次更新为工作节点增加了按平台区分最大录制数和当前录制数的功能。通过这一功能，可以对不同平台的录制容量进行独立配置，例如：
- 一个工作节点可以配置支持抖音平台最大录制数3
- 同时配置支持京东平台最大录制数5
- 系统会分别跟踪每个平台的当前录制数

## 数据库迁移步骤

1. 执行数据库迁移创建新表：
   ```bash
   npx prisma migrate dev --name add_worker_node_platform_capacity
   ```
   或手动执行SQL脚本：`prisma/migrations/worker_node_platform_capacity_migration.sql`

2. 执行数据迁移脚本，将现有工作节点的容量配置迁移到新模型：
   ```bash
   pnpm run migrate:worker-platform-capacity
   ```

## 功能变更说明

### 数据模型变更
- 新增 `WorkerNodePlatformCapacity` 模型，关联工作节点和平台
- 保留原有 `WorkerNode` 模型中的 `maxRecordings` 和 `currentRecordings` 字段作为默认值和向后兼容

### 界面变更
- 工作节点列表页面新增按平台查看的标签页
- 每个平台标签页显示该平台的最大录制数和当前录制数
- 总览页面显示所有平台的汇总信息

### API变更
- 新增 `/api/admin/worker-nodes/[id]/platform-capacity` 端点，用于管理工作节点的平台容量
- 修改了任务启动逻辑，现在会优先考虑平台特定的容量配置

## 如何配置

1. 管理员可以在工作节点管理界面的平台标签页中，为每个工作节点配置不同平台的最大录制数
2. 如果未配置特定平台，系统将使用工作节点的默认最大录制数
3. 系统会自动根据直播流所属平台来更新相应平台的当前录制数

## 注意事项

1. 迁移后，所有工作节点将保持原有的录制容量数据，同时为每个平台创建相同的默认配置
2. 任务启动时，会优先选择具有足够平台特定容量的工作节点
3. 当一个工作节点同时处理多个平台的直播流时，每个平台的容量是独立计算的 